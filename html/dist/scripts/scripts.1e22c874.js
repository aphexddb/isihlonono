"use strict";angular.module("isihlononoApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.router"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.when("","/").otherwise("/404").rule(function(a,b){var c=b.path();"/"!==c&&"/"===c.slice(-1)&&b.replace().path(c.slice(0,-1))}),a.state("app",{abstrct:!0,templateUrl:"views/app.html"}).state("app.404",{url:"/404",templateUrl:"views/404.html"}).state("app.home",{url:"/",templateUrl:"views/home.html",controller:"HomeCtrl"}).state("app.noise",{url:"/noise",templateUrl:"views/noise.html",controller:"NoiseCtrl"})}]).run(["$rootScope","$state","$stateParams",function(a,b,c){a.$state=b,a.$stateParams=c}]).controller("BodyController",["$rootScope",function(a){a.online=!1}]),angular.module("isihlononoApp").factory("UA",[function(){var a=new UAParser,b=a.getResult();return b.toString=function(){var a="";void 0!==b.device.vendor&&(a=b.device.vendor+" "+b.device.model+" "+b.device.type);var c=a+" "+b.browser.name+" "+b.browser.major+" on "+b.os.name;return c.trim()},b}]),angular.module("isihlononoApp").constant("GRAVITY",9.80665).factory("Motion",["GRAVITY",function(){var a=function(){var a=this;this.doTare=!1,this.tareValues={x:0,y:0,z:0},this.online=!1,this.callback=null,this.data={},this.data.lastDM=(new Date).getTime(),this.data.aX=0,this.data.aY=0,this.data.aZ=0,this.data.alpha=null,this.data.beta=null,this.data.gamma=null,this.tare=function(){this.doTare=!0},this.setOnline=function(a){this.online=a},this.setMotionCallback=function(a){this.callback=a},this._tareVal=function(a,b){return a-b},this._dmHdlr=function(a,b,c,d,e,f){var g=(new Date).getTime();g<this.data.lastDM+100||(this.data.lastDM=g,a=a?this._tareVal(a,this.tareValues.x):0,b=b?this._tareVal(b,this.tareValues.y):0,c=c?this._tareVal(c,this.tareValues.z):0,this.data.aX=a,this.data.aY=b,this.data.aZ=c,this.data.alpha=d?d:0,this.data.beta=e?e:0,this.data.gamma=f?f:0,null!==this.callback&&this.online&&this.callback([this.data.aX,this.data.aY,this.data.aZ,this.data.alpha,this.data.beta,this.data.gamma]))},window.DeviceMotionEvent?window.addEventListener("devicemotion",function(b){var c=b.accelerationIncludingGravity;a.doTare&&(a.tareValues.x=c.x,a.tareValues.y=c.y,a.tareValues.z=c.z,a.doTare=!1),b.rotationRate&&(null!==b.rotationRate.alpha?a._dmHdlr(c.x,c.y,c.z,b.rotationRate.alpha,b.rotationRate.beta,b.rotationRate.gamma):a._dmHdlr(c.x,c.y,c.z,null,null,null))},!1):console.error("devicemotion not supported on your device or browser.")};return new a}]),angular.module("isihlononoApp").factory("Touch",[function(){var a=function(){var a=this;this.online=!1,this.hammertime=null,this.elementId=null,this.e=null,this.opts={},this.callback=null,this.data={x:0,y:0,deltaX:0,deltaY:0,velocity:0},this.mousePosition={x:0,y:0},this.width=window.innerWidth,this.height=window.innerHeight,this.getMouseXY=function(b){var c=b.pageX,d=b.pageY;0>c&&(c=0),0>d&&(d=0),c>a.width&&(c=a.width),d>a.height&&(d=a.height),a.mousePosition={x:c,y:d}},this.convertRange0to1=function(a,b){var c=0,d=1,e=0;return(a-e)/(b-e)*(d-c)+c},this.rangeMouseCoords=function(b,c,d,e){return{x:a.convertRange0to1(b,c),y:a.convertRange0to1(d,e)}},this.rangeDeltaValues=function(b,c){var d=a.width/2,e=a.height/2;return 0>b&&Math.abs(b)>d&&(b=-d),b>0&&b>d&&(b=d),0>c&&Math.abs(c)>e&&(c=-e),c>0&&c>e&&(c=e),{x:a.convertRange0to1(b,d),y:a.convertRange0to1(c,e)}},document.onmousemove=this.getMouseXY,this.setOnline=function(a){this.online=a},this.watchElement=function(b){this.elementId=b,this.e=document.getElementById(this.elementId),this.hammertime=new Hammer(this.e,this.opts),this.hammertime.on("pan",function(b){var c=a.rangeMouseCoords(a.mousePosition.x,a.width,a.mousePosition.y,a.height),d=a.rangeDeltaValues(b.deltaX,b.deltaY);a.data={x:c.x,y:c.y,deltaX:d.x,deltaY:-1*d.y,velocity:Math.abs(b.velocity)},a.online&&null!=a.callback&&a.callback(a.data)})},this.setCallback=function(b){a.callback=b}};return new a}]),angular.module("isihlononoApp").factory("ConductorService",["$rootScope","$timeout",function(a,b){var c="ws://"+window.location.hostname+":8081/ws/conductor",d=null,e=null,f=null,g=!1,h={},i=5e3,j={0:"websocket connection not yet open",1:"websocket connection open and ready to communicate",2:"websocket connection in the process of closing",3:"websocket connection closed or couldn't be opened"},k=function(){l()},l=function(a){e=new WebSocket(c),e.onopen=function(){var b=event.currentTarget.readyState;console.log("Conductor:",j[b]),f(!0),g=!0,void 0!==a&&a()},e.onclose=function(){console.log("Conductor: websocket connection closed, will attempt to reconnect in",i/1e3,"seconds"),b(k,i),f(!1),g=!1},e.onmessage=function(a){null!==d&&d(JSON.parse(a.data))}};return h.setOnlineCallback=function(a){f=a},h.setCallback=function(a){d=a},h.connect=function(){l()},h.send=function(a){g&&e.send(JSON.stringify(a))},h.sendNow=function(a){e.send(JSON.stringify(a))},h}]),angular.module("isihlononoApp").controller("HomeCtrl",["$scope","$rootScope","ConductorService","Motion","UA","Touch",function(a,b,c,d,e,f){c.setOnlineCallback(function(d){a.$apply(function(){b.online=d,c.sendNow({event:"performerOnline",data:{ua:e.toString()}}),f.setOnline(d)})})}]).controller("ClientCtrl",["$scope","ConductorService","Motion","Touch",function(a,b,c,d){a.performer=null,a.motionData=null;var e="hsla(360, 100%, 100%, 1)",f=function(a){this.c=document.getElementById(a),this.ctx=this.c.getContext("2d"),this.centerX=this.c.width/2,this.centerY=this.c.height/2,this.radius=30,this.startAngle=0,this.endAngle=2*Math.PI,this.draw=function(a,b,c){this.ctx.clearRect(0,0,this.c.width,this.c.height),this.centerX=this.c.width/2,this.centerY=this.c.height/2,this.ctx.beginPath();var d=this.centerX+a,f=this.centerY+b,g=Math.abs(this.radius+c);this.ctx.arc(d,f,g,this.startAngle,this.endAngle),this.ctx.lineWidth=5,this.ctx.strokeStyle=e,this.ctx.stroke()}};b.setCallback(function(b){void 0!==b.performer&&a.$apply(function(){a.performer=b.performer,e="hsla("+b.performer.altColor+", 100%, 50%, 1)"}),void 0!==b.acceptInput&&(console.log("Conductor is ready to accept input"),c.setOnline(!0))}),b.connect();var g=new f("gameCanvas");g.draw(0,0),c.setMotionCallback(function(c){var d=10;a.$apply(function(){a.motionData=c,g.draw(c[0]*d,c[1]*d,c[2]*d),b.send({event:"motion",data:[c[0],c[1],c[2],c[3],c[4],c[5]]})})}),d.setCallback(function(c){a.$apply(function(){a.touch=c,b.send({event:"touch",data:[c.x,c.y,c.deltaX,c.deltaY,c.velocity]})})}),d.watchElement("touchArea"),a.tare=function(){c.tare()}}]),angular.module("isihlononoApp").controller("NoiseCtrl",["$scope","$rootScope","ConductorService",function(a,b,c){a.conductorReady=!1;var d=10;a.channels=new Array(d);for(var e=0;d>e;e++)a.channels[e]={};c.setOnlineCallback(function(c){a.$apply(function(){b.online=c,c||(a.conductorReady=!1)})}),c.setCallback(function(b){void 0!==b.performers&&a.$apply(function(){var c=new Array(d);for(var e in b.performers)b.performers.hasOwnProperty(e)&&(a.channels[b.performers[e].channelNumber]=b.performers[e],c[b.performers[e].channelNumber]=1);for(var f=0;d>f;f++)1===c[f]?a.channels[f].state="open":a.channels[f]={state:"closed",active:!1,channelNumber:f}}),void 0!==b.conductorReady&&a.$apply(function(){a.conductorReady=!0})}),c.connect(),a.conduct=function(){b.online&&c.send({event:"conductorOnline",data:null})},a.setActive=function(a,b){c.send({event:"toggleActive",data:{channel:a,active:b}})}}]);