"use strict";angular.module("isihlononoApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.router"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.when("","/").otherwise("/404").rule(function(a,b){var c=b.path();"/"!==c&&"/"===c.slice(-1)&&b.replace().path(c.slice(0,-1))}),a.state("app",{abstrct:!0,templateUrl:"views/app.html"}).state("app.404",{url:"/404",templateUrl:"views/404.html"}).state("app.home",{url:"/",templateUrl:"views/home.html",controller:"HomeCtrl"}).state("app.noise",{url:"/noise",templateUrl:"views/noise.html",controller:"NoiseCtrl"})}]).run(["$rootScope","$state","$stateParams",function(a,b,c){a.$state=b,a.$stateParams=c}]).controller("BodyController",["$rootScope",function(a){a.online=!1}]),angular.module("isihlononoApp").factory("UA",[function(){var a=new UAParser,b=a.getResult();return b.toString=function(){var a="";void 0!==b.device.vendor&&(a=b.device.vendor+" "+b.device.model+" "+b.device.type);var c=a+" "+b.browser.name+" "+b.browser.major+" on "+b.os.name;return c.trim()},b}]),angular.module("isihlononoApp").constant("GRAVITY",9.80665).constant("SAMPLE_RATE_MS",50).factory("Motion",["SAMPLE_RATE_MS",function(a){var b=function(){var b=this;this.doTare=!1,this.tareValues={x:0,y:0,z:0},this.online=!1,this.callback=null,this.data={},this.data.lastDM=(new Date).getTime(),this.data.aX=0,this.data.aY=0,this.data.aZ=0,this.data.alpha=null,this.data.beta=null,this.data.gamma=null,this.tare=function(){this.doTare=!0},this.setOnline=function(a){this.online=a},this.setMotionCallback=function(a){this.callback=a},this._tareVal=function(a,b){return a-b},this._dmHdlr=function(b,c,d,e,f,g){var h=(new Date).getTime();h<this.data.lastDM+a||(this.data.lastDM=h,b=b?this._tareVal(b,this.tareValues.x):0,c=c?this._tareVal(c,this.tareValues.y):0,d=d?this._tareVal(d,this.tareValues.z):0,this.data.aX=b,this.data.aY=c,this.data.aZ=d,this.data.alpha=e?e:0,this.data.beta=f?f:0,this.data.gamma=g?g:0,null!==this.callback&&this.online&&this.callback([this.data.aX,this.data.aY,this.data.aZ,this.data.alpha,this.data.beta,this.data.gamma]))},window.DeviceMotionEvent?window.addEventListener("devicemotion",function(a){var c=a.accelerationIncludingGravity;b.doTare&&(b.tareValues.x=c.x,b.tareValues.y=c.y,b.tareValues.z=c.z,b.doTare=!1),a.rotationRate&&(null!==a.rotationRate.alpha?b._dmHdlr(c.x,c.y,c.z,a.rotationRate.alpha,a.rotationRate.beta,a.rotationRate.gamma):b._dmHdlr(c.x,c.y,c.z,null,null,null))},!1):console.error("devicemotion not supported on your device or browser.")};return new b}]),angular.module("isihlononoApp").factory("Touch",[function(){var a=function(){var a=this;this.online=!1,this.hammertime=null,this.elementId=null,this.e=null,this.opts={},this.callback=null,this.data={x:0,y:0,deltaX:0,deltaY:0,velocity:0},this.mousePosition={x:0,y:0},this.width=window.innerWidth,this.height=window.innerHeight,this.getMouseXY=function(b){var c=b.pageX,d=b.pageY;0>c&&(c=0),0>d&&(d=0),c>a.width&&(c=a.width),d>a.height&&(d=a.height),a.mousePosition={x:c,y:d}},this.convertRange0to1=function(a,b){var c=0,d=1,e=0;return(a-e)/(b-e)*(d-c)+c},this.rangeMouseCoords=function(b,c){return 0>b&&(b=0),b>a.width&&(b=a.width),0>c&&(c=0),c>a.height&&(c=a.height),{x:a.convertRange0to1(b,a.width),y:a.convertRange0to1(c,a.height)}},this.rangeDeltaValues=function(b,c){var d=a.width/2,e=a.height/2;return 0>b&&Math.abs(b)>d&&(b=-d),b>0&&b>d&&(b=d),0>c&&Math.abs(c)>e&&(c=-e),c>0&&c>e&&(c=e),{x:a.convertRange0to1(b,d),y:a.convertRange0to1(c,e)}},this.setOnline=function(a){this.online=a},this.watchElement=function(b){this.elementId=b,this.e=document.getElementById(this.elementId),this.hammertime=new Hammer(this.e,this.opts),this.hammertime.on("pan",function(b){var c=a.rangeMouseCoords(b.center.x,b.center.y),d=a.rangeDeltaValues(b.deltaX,b.deltaY);a.data={x:c.x,y:c.y,deltaX:d.x,deltaY:-1*d.y,velocity:Math.abs(b.velocity)},a.online&&null!=a.callback&&a.callback(a.data)})},this.setCallback=function(b){a.callback=b}};return new a}]),angular.module("isihlononoApp").factory("GrandCentralService",["$rootScope","$timeout",function(a,b){var c="ws://"+window.location.hostname+":8081/ws",d=null,e=null,f=null,g=!1,h={},i=5e3,j={0:"ws connection not yet open",1:"ws connection open and ready to communicate",2:"ws connection in the process of closing",3:"ws connection closed or couldn't be opened"},k=function(){l()},l=function(a){d=new WebSocket(c),d.onopen=function(){var b=event.currentTarget.readyState;console.log("Grand Central:",j[b]),f(!0),g=!0,void 0!==a&&a()},d.onclose=function(){console.log("Grand Central: ws connection closed, will attempt to reconnect in",i/1e3,"seconds"),b(k,i),f(!1),g=!1},d.onmessage=function(a){null!==e&&e(JSON.parse(a.data))},d.onerror=function(a){var b=a.currentTarget.readyState;console.log("Grand Central:",j[b])}};return h.setOnlineStateChangeCallback=function(a){f=a},h.setOnMessageCallback=function(a){e=a},h.connect=function(){l()},h.send=function(a){1==d.readyState?d.send(JSON.stringify(a)):console.log("Grand Central: unable to send ("+j[d.readyState]+")")},h}]),angular.module("isihlononoApp").controller("HomeCtrl",["$scope","$rootScope","GrandCentralService","Motion","UA","Touch",function(a,b,c,d,e,f){c.setOnlineStateChangeCallback(function(d){a.$apply(function(){b.online=d,c.send({event:"performerOnline",data:{ua:e.toString()}})})}),f.setOnline(!1),d.setOnline(!1)}]).controller("ClientCtrl",["$scope","GrandCentralService","Motion","Touch",function(a,b,c,d){a.performer=null,a.motionData=null;var e="hsla(360, 100%, 100%, 1)",f=function(a){this.c=document.getElementById(a),this.ctx=this.c.getContext("2d"),this.centerX=Math.floor(this.c.width/2),this.centerY=Math.floor(this.c.height/2),this.radius=30,this.startAngle=0,this.endAngle=2*Math.PI,this.draw=function(a,b,c){this.ctx.clearRect(0,0,this.c.width,this.c.height),this.ctx.lineJoin="round",this.centerX=Math.floor(this.c.width/2),this.centerY=Math.floor(this.c.height/2),this.ctx.beginPath();var d=this.centerX+a,f=this.centerY+b,g=Math.abs(this.radius+c);this.ctx.arc(d,f,g,this.startAngle,this.endAngle),this.ctx.lineWidth=5,this.ctx.strokeStyle=e,this.ctx.stroke()}};b.setOnMessageCallback(function(b){"performer"==b.event?a.$apply(function(){a.performer=b.data,e="hsla("+a.performer.altColor+", 100%, 50%, 1)",a.performer.active&&(d.setOnline(!0),c.setOnline(!0))}):console.log("received data",b)}),b.connect();var g=new f("gameCanvas");g.draw(0,0),c.setMotionCallback(function(c){a.$apply(function(){a.motionData=c;var d=10,e=5;g.draw(c[0]*d,c[1]*d,c[2]*e),b.send({event:"motion",data:[c[0],c[1],c[2],c[3],c[4],c[5]]})})}),d.setCallback(function(c){a.$apply(function(){a.touch=c,b.send({event:"touch",data:[c.x,c.y,c.deltaX,c.deltaY,c.velocity]})})}),d.watchElement("touchArea"),a.tare=function(){c.tare()}}]),angular.module("isihlononoApp").controller("NoiseCtrl",["$scope","$rootScope","GrandCentralService",function(a,b,c){a.conductorReady=!1,a.channels=[],c.setOnlineStateChangeCallback(function(d){a.$apply(function(){b.online=d,d&&c.send({event:"conductorOnline",data:null})})}),c.setOnMessageCallback(function(b){"conductorReady"==b.event?a.$apply(function(){a.conductorReady=!0}):"performers"==b.event?a.$apply(function(){for(var c=0;c<b.data.channels.length;c++){{var d=b.data.channels[c].channelNumber,e={state:"closed",active:!1,channelNumber:d,motionData:null,touchData:null,mood:null,userAgent:null,performerId:null};_.find(b.data.performers,function(a){a.channelNumber===d&&(e={state:"open",active:"true"==a.active||1==a.active,channelNumber:d,motionData:a.motionData,touchData:a.touchData,mood:a.mood,userAgent:a.userAgent,performerId:a.id})})}a.channels[d]=e}}):console.log("received data",b)}),c.connect(),a.setActive=function(a,b){c.send({event:"toggleChannelOutput",data:{channel:a,active:b}})},a.changeMood=function(a,b){c.send({event:"changeMood",data:{performerId:a,mood:b}})}}]);